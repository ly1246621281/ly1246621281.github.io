<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8" >
    <meta name="baidu-site-verification" content="dIcXMeY8Ya" />
    
    <title>Hexo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" >
    <meta name="keywords" content="ZK, 前端, Web, 张德龙, 前端开发" >
    <meta name="description" content="ZK个人小站" >

    
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml" >
    
    
    <link rel="shortcut icon" href="/favicon.ico" >
    
    
<link rel="stylesheet" href="/css/style.css">

    <!--[if lt IE 9]>
    
<script src="/js/html5.js"></script>

    <![endif]-->
    
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d5ebf515ab530cfbdda5f5c85093fb41";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 5.2.0"></head>

<body class="home">
    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a target="_blank" rel="noopener" href="http://browsehappy.com/">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="/">
                <div class="cover">
                    <span class="name">Hexo</span>
                    <span class="description"></span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="/2023/10/07/UPMP/%E8%BF%90%E8%90%A5%E7%9C%8B%E6%9D%BF%E4%BC%98%E5%8C%962.0/index.html" class="item ">
                <a href="/" title="首页" class="icon-home">&nbsp;首页</a>
            </li>
            
            <li rel="/2023/10/07/UPMP/%E8%BF%90%E8%90%A5%E7%9C%8B%E6%9D%BF%E4%BC%98%E5%8C%962.0/index.html" class="item ">
                <a href="/lab/" title="XX" class="icon-lab">&nbsp;XX</a>
            </li>
            
            <li rel="/2023/10/07/UPMP/%E8%BF%90%E8%90%A5%E7%9C%8B%E6%9D%BF%E4%BC%98%E5%8C%962.0/index.html" class="item ">
                <a href="/about/" title="关于" class="icon-about">&nbsp;关于</a>
            </li>
            
            <li rel="/2023/10/07/UPMP/%E8%BF%90%E8%90%A5%E7%9C%8B%E6%9D%BF%E4%BC%98%E5%8C%962.0/index.html" class="item ">
                <a href="/comment/" title="留言" class="icon-comment">&nbsp;留言</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    
                        <a href="https://github.com/ly1246621281" target="_blank">Github</a>
                        |
                    
                        <a href="https://pages.coding.me" target="_blank">Hosted by Coding Pages</a>
                        
                    
                </p>
                <p class="sns">
                    
                        <a href="http://weibo.com" class="sinaweibo" target="_blank"><b>■</b> 新浪微博</a>
                    
                        <a href="https://www.facebook.com/profile.php?id=100011855760219&amp;ref=bookmarks" class="qqweibo" target="_blank"><b>■</b> Facebook</a>
                    
                    <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        公众号
                        <span class="popover">
                            <img src="/img/wechat_mp.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a>
                </p>
                
            </div>
            <div class="avatar fr">
                <img src="/img/jelon.jpg" alt="avatar" title="Jelon" >
            </div>
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 文章页 -->
<!-- 文章 -->
<article class="post article">
    <header class="text-center">
        <h3 class="post-title"><span></span></h3>
    </header>
    <p class="post-meta text-center">
        Jelon 发表于
        <time datetime="2023-10-07T07:10:27.552Z">2023-10-07</time>
    </p>
    <div class="post-content">
        <hr>
<p>title:运营看板优化2.0<br>date:2021.01.25<br>tag:JAVA,Project</p>
<hr>
<h1 id="运营看板口径统一-性能优化技术方案"><a href="#运营看板口径统一-性能优化技术方案" class="headerlink" title="运营看板口径统一+性能优化技术方案"></a>运营看板口径统一+性能优化技术方案</h1><h2 id="一-口径统一"><a href="#一-口径统一" class="headerlink" title="一.口径统一"></a>一.口径统一</h2><ol>
<li>界面增加相关字段</li>
</ol>
<blockquote>
<ul>
<li><p>所有的下钻列表页增加“活动名称”列，此列展示活动对应的活动名称</p>
</li>
<li><p>下钻页面增加派发效率</p>
</li>
<li><p>小数保留修改（界面展示与下载）</p>
</li>
</ul>
</blockquote>
<ol start="2">
<li>筛选条件修改<blockquote>
<ul>
<li>T+1 更新要求每日12点，需调整分表时间</li>
<li>活动状态对活动中，暂停，完成SQL修改成统计周期内有过此状态。</li>
<li>统计周期修改为实际开始时间和实际结束时间+60<img src="https://i.loli.net/2021/01/28/W82RQa1MzUGJ9cH.png" alt="image-20210128154920702"></li>
</ul>
</blockquote>
</li>
</ol>
<p>3.核心指标修改</p>
<blockquote>
<ul>
<li><p>总派发量，实际出库量。</p>
<ul>
<li>数据侧推送每日活动粒度的派发量</li>
</ul>
</li>
<li><p>派发收入  send_income字段由原先定值合同金额修改为变值（出库件数*单价）。</p>
<ul>
<li>数据侧推送每日活动粒度的派发收入</li>
</ul>
</li>
<li><p>成交用户数，成交新用户数：<strong>单活动去重，活动之间不去重</strong></p>
</li>
<li><p>计划派发总量 ， 每天计划派发数量*统计周期内实际派发天数</p>
</li>
<li><p>$$<br>派发效率 = ∑1…n[（单活动a单日派发效率 + 单活动b单日派发效率 + …)/活动个数]/统计周期<br>$$</p>
</li>
<li><p>进行中的活动数，统计的是总活动中==截止统计结束时间==还处于“派发中”状态的活动数。与筛选条件中有过进行中不一致。</p>
</li>
</ul>
</blockquote>
<p>4.实时界面修改</p>
<blockquote>
<ul>
<li>未开始：结束时间大于查询时间点，并且活动状态是“已创建（待开启）”、“待开始（待派发）”的活动。</li>
<li>进行中：  活动状态为“派发中”状态的活动。  </li>
<li>预警：活动总计划派发量为创建活动时维护的总数量，派发天数为创建活动时维护的活动结束时间减去活动开始时间，按照小时折合成天数（精确到一位小数，四舍五入）计算，比如2个小时为0.1天；每天计划派发量若有小数则四舍五入取整。备注：若当天实际只派发了几个小时，当天派发数量肯定会低于每天计划派发数量，产生预警；还有在派发速度较快的情况下，派发效率基本都会大于1；</li>
</ul>
</blockquote>
<p>5.转化分析修改</p>
<blockquote>
<ul>
<li>修改细节同上</li>
</ul>
</blockquote>
<h2 id="二-性能优化"><a href="#二-性能优化" class="headerlink" title="二.性能优化"></a>二.性能优化</h2><h3 id="数据源方面"><a href="#数据源方面" class="headerlink" title="数据源方面"></a>数据源方面</h3><ol>
<li>分表</li>
</ol>
<blockquote>
<p>解决问题：</p>
<p>运营看板pin表每天8w左右递增，需要分表</p>
</blockquote>
<ol start="2">
<li>分库</li>
</ol>
<blockquote>
<p>解决问题：</p>
<p>长时间SQL处理，数据库QPS升高，影响生产sql处理速度</p>
</blockquote>
<h3 id="代码方面"><a href="#代码方面" class="headerlink" title="代码方面"></a>代码方面</h3><p>1.引用线程池。</p>
<ul>
<li><p>在前端页面请求接口，查询按钮点击即并行发送多个请求接口，此处无需优化</p>
</li>
<li><p>在对比指标处，加入线程池，若对比指标有数据，效率提升。</p>
<p><img src="https://i.loli.net/2021/01/27/AEp5rsztS3vQynk.png" alt="image-20210127204455247"></p>
</li>
<li><p>细化SQL 增加索引</p>
</li>
</ul>
<h2 id="三-解决上线安全漏洞问题-SQL注入"><a href="#三-解决上线安全漏洞问题-SQL注入" class="headerlink" title="三.解决上线安全漏洞问题-SQL注入"></a>三.解决上线安全漏洞问题-SQL注入</h2><p>​    针对 运营看板下钻界面按列排序问题，之前设计是由前端输入动态列名，后端直接排序。</p>
<p>​    0容易引发SQL注入风险，修改为Mybatis静态判断是否按选定列排序</p>
<h2 id="四-待确认项"><a href="#四-待确认项" class="headerlink" title="四.待确认项"></a>四.待确认项</h2><ul>
<li>TODO: 计划派发总量怎么计算。</li>
<li>派发效率：单活动总出库数/计划派发总量？</li>
<li>实时统计，进行中的活动不包含暂停和顺延后的？</li>
<li>预警活动说明，不明确？</li>
<li>活动概况里的 进行中的活动是否剔除暂停和延后？</li>
<li>对于采销经理角色（目前无活动管理和统计信息查询权限）需要新增权限。</li>
<li>成交额展示增加 其他用户成交额。  是取消了嘛？</li>
</ul>
<p>·    计划派发总量怎么计算。——</p>
<p>·      派发进度中计划派发总量=每日计划派发个数 * 统计周期时长；其中每日计划派发个数 = 活动信息中计划派发总量 / （计划结束日期-计划开始日期）。</p>
<p>·    派发效率：单活动总出库数/计划派发总量？</p>
<p>·    <img src="C:/Users/ZHANGK~1/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg" alt="img"> </p>
<p>·    实时统计，进行中的活动不包含暂停和顺延后的？——按照prd描述，不包含暂停和顺延 </p>
<p>只统计当前为派发中的活动  需更改PRD@吴晶晶</p>
<p>·    预警活动说明，不明确？——不明确的点具体是什么？</p>
<p>​      预警活动为派发效率&lt;1的活动</p>
<p>·    活动概况里的 进行中的活动是否剔除暂停和延后？——活动概况中的进行中活动不包含暂停和顺延状态</p>
<p>只统计当前为派发中的活动   需更改PRD@吴晶晶</p>
<p>·    对于采销经理角色（目前无活动管理和统计信息查询权限）需要新增权限。——此行内容非本次prd新增，可与一期prd对比</p>
<p>去掉此处权限管理，活动看板再考虑是否有权限设置   需更改PRD@吴晶晶</p>
<p>·    成交额展示增加 其他用户成交额。 是取消了嘛？——prd评审时，数据侧确认不会有其他用户场景，因而在prd中删除了其他用户</p>
<p>是取消了，不再考虑</p>
<h2 id="五-修改记录"><a href="#五-修改记录" class="headerlink" title="五. 修改记录"></a>五. 修改记录</h2><ol>
<li><p>数据库修改</p>
<blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> board_activity <span class="keyword">add</span> </span><br><span class="line"> real_end_time <span class="built_in">timestamp</span> <span class="keyword">default</span>  <span class="string">&#x27;0000-00-00 00:00:00&#x27;</span> <span class="keyword">comment</span> <span class="string">&#x27;实际派发结束时间&#x27;</span>; </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> board_activity <span class="keyword">add</span> </span><br><span class="line"> real_start_time <span class="built_in">timestamp</span> <span class="keyword">default</span>  <span class="string">&#x27;0000-00-00 00:00:00&#x27;</span> <span class="keyword">comment</span> <span class="string">&#x27;实际派发开始时间&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> board_activity <span class="keyword">add</span> </span><br><span class="line"> send_efficiency <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">4</span>) <span class="keyword">default</span>  <span class="string">&#x27;0.0&#x27;</span> <span class="keyword">comment</span> <span class="string">&#x27;当日派发效率&#x27;</span>; </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> board_activity <span class="keyword">modify</span> </span><br><span class="line"> activity_days <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">4</span>) <span class="keyword">default</span>  <span class="string">&#x27;0.0&#x27;</span> <span class="keyword">comment</span> <span class="string">&#x27;活动天数&#x27;</span>; </span><br></pre></td></tr></table></figure>
<p>‘</p>
</blockquote>
<p>2.代码修改</p>
<blockquote>
<p>枚举类中：</p>
<ul>
<li>OperatorTaskEnum 记录所有任务</li>
<li>OperatorTaskContant 下钻详情公式记录以及公式对应的任务映射枚举类</li>
<li>OperatorDetailEnum 记录和前端下钻排序列一一映射的枚举类。和OperatorTaskContant 配合找到执行任务</li>
<li>OperatorQueryPointEnum 复用SQL的筛选条件枚举类，在任务里填充QueryParam参数</li>
</ul>
</blockquote>
</li>
</ol>
<h2 id="六-Sharding记录"><a href="#六-Sharding记录" class="headerlink" title="六.Sharding记录"></a>六.Sharding记录</h2><p>SQL 不支持：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> activityCount <span class="keyword">from</span> (</span><br><span class="line"><span class="keyword">select</span>  activity_id,user_log_acct</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">board_activity_pin</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">&lt;<span class="keyword">include</span> refid=<span class="string">&quot;com.jd.y.upack.core.board.mapper.TargetCommonTransformDao.queryConditionForTrans&quot;</span>/&gt;</span><br><span class="line"><span class="keyword">and</span> is_send_trial_sku = <span class="number">1</span></span><br><span class="line">&lt;<span class="keyword">if</span> <span class="keyword">test</span> = <span class="string">&#x27;queryParamBO.activityId != null&#x27;</span>&gt;</span><br><span class="line">    <span class="keyword">and</span> activity_id = <span class="comment">#&#123;queryParamBO.activityId&#125;</span></span><br><span class="line">&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">)t</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(sendCount) <span class="keyword">as</span> activityCount <span class="keyword">from</span> (</span><br><span class="line"><span class="keyword">select</span>  activity_id,<span class="keyword">count</span>(<span class="keyword">distinct</span> user_log_acct) <span class="keyword">as</span> sendCount</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">board_activity_pin</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">&lt;<span class="keyword">include</span> refid=<span class="string">&quot;com.jd.y.upack.core.board.mapper.TargetCommonTransformDao.queryConditionForTrans&quot;</span>/&gt;</span><br><span class="line"><span class="keyword">and</span> is_send_trial_sku = <span class="number">1</span></span><br><span class="line">&lt;<span class="keyword">if</span> <span class="keyword">test</span> = <span class="string">&#x27;queryParamBO.activityId != null&#x27;</span>&gt;</span><br><span class="line">    <span class="keyword">and</span> activity_id = <span class="comment">#&#123;queryParamBO.activityId&#125;</span></span><br><span class="line">&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> activity_id</span><br><span class="line">)t</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Sql解析错误</p>
<p><img src="https://i.loli.net/2021/03/13/E7ijQkrsGUnhTcy.png" alt="image-20210313163843041"></p>
</li>
</ul>
<p><img src="https://i.loli.net/2021/03/10/ztoD8rNUiQJkW5M.png" alt="image-20210310210957628"></p>
<p><img src="https://i.loli.net/2021/03/10/XxAQa7i3HyLMlDd.png" alt="image-20210310211034835"></p>
<p>解决方式：</p>
<ol>
<li><p><img src="https://i.loli.net/2021/03/13/cVe9JMUdQn2LP7W.png" alt="image-20210313163703032"></p>
<p><img src="https://i.loli.net/2021/03/13/r3DkM4haAwcPvWz.png" alt="image-20210313165211886"></p>
</li>
<li><p>按路由建去查询，然后汇总。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">protected Map&lt;Integer, List&lt;Integer&gt;&gt; groupActivityIds(List&lt;Integer&gt; activitys) &#123;</span><br><span class="line">    if (CollectionUtils.isNotEmpty(activitys)) &#123;</span><br><span class="line">        return activitys.stream().collect(Collectors.</span><br><span class="line">                groupingBy(t -&gt; t % 8, Collectors.collectingAndThen(Collectors.toList(), Function.identity())));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return new HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected List&lt;SendTrendPO&gt; shardingRouteByActivityId(QueryParamBO statisticsQuery) &#123;</span><br><span class="line">    Map&lt;Integer, List&lt;Integer&gt;&gt; activityIdMap &#x3D; groupActivityIds(statisticsQuery.getActivityIds());</span><br><span class="line">    List&lt;SendTrendPO&gt; transformResults &#x3D; Lists.newArrayList();</span><br><span class="line">    for (List&lt;Integer&gt; activityIds : activityIdMap.values()) &#123;</span><br><span class="line">        List&lt;SendTrendPO&gt; transformResult &#x3D; this.sqlProcess(statisticsQuery, activityIds);</span><br><span class="line">        transformResults.addAll(transformResult);</span><br><span class="line">    &#125;</span><br><span class="line">    return transformResults;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected List&lt;SendTrendPO&gt; sqlProcess(QueryParamBO statisticsQuery, List&lt;Integer&gt; activityIds) &#123;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<ul>
<li><p>多路由但无法汇总</p>
<p><img src="https://i.loli.net/2021/03/13/CKdXkQ9U1LODbPH.png" alt="image-20210313164308078"></p>
</li>
</ul>
<blockquote>
<p>分析需求,是否有必要count distinct。其次可考虑按路由建一起分组，即group by activity_id,activity_dt</p>
</blockquote>
<h2 id="七-SQL代码记录"><a href="#七-SQL代码记录" class="headerlink" title="七.SQL代码记录"></a>七.SQL代码记录</h2><h3 id="1-核心指标"><a href="#1-核心指标" class="headerlink" title="1.核心指标"></a>1.核心指标</h3><ul>
<li><p>下载</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">	o.activity_id <span class="keyword">as</span> activityId,</span><br><span class="line">	a.<span class="string">`name`</span> <span class="keyword">as</span> activityName,</span><br><span class="line">	a.create_by <span class="keyword">as</span> createBy,</span><br><span class="line">	c.code <span class="keyword">as</span> commodityCode,</span><br><span class="line">	o.store_id <span class="keyword">as</span> storeId,</span><br><span class="line">	o.dc_id <span class="keyword">as</span> dcId,</span><br><span class="line">	<span class="keyword">count</span>(o.id) <span class="keyword">as</span> storeSendCount</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">	order_record o</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> activity a <span class="keyword">on</span></span><br><span class="line">	o.activity_id = a.id</span><br><span class="line">	<span class="keyword">and</span> a.deleted = <span class="number">0</span></span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> commodity c <span class="keyword">on</span></span><br><span class="line">	a.id = c.activity_id</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">	stock_status = <span class="number">4</span></span><br><span class="line">	<span class="keyword">and</span> (o.update_time <span class="keyword">between</span> <span class="keyword">DATE_FORMAT</span>( <span class="string">&#x27;2020-09-15 14:33:56.0&#x27;</span>, <span class="string">&#x27;%Y-%m-%d&#x27;</span>) <span class="keyword">and</span> <span class="keyword">DATE_FORMAT</span>( <span class="string">&#x27;2021-03-13 14:33:56.0&#x27;</span>, <span class="string">&#x27;%Y-%m-%d&#x27;</span>))</span><br><span class="line">	<span class="keyword">and</span> a.id <span class="keyword">in</span> ( <span class="number">10187</span> , <span class="number">10343</span> , <span class="number">10345</span> , <span class="number">10346</span> , <span class="number">10347</span> , <span class="number">10348</span> )</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">	o.activity_id,</span><br><span class="line">	o.dc_id,</span><br><span class="line">	o.store_id;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">	activity_id <span class="keyword">as</span> activityId,</span><br><span class="line">	<span class="keyword">count</span>(<span class="keyword">id</span>) <span class="keyword">as</span> storeSendAllTotal</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">	order_record</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">	stock_status = <span class="number">4</span></span><br><span class="line">	<span class="keyword">and</span> (update_time <span class="keyword">between</span> <span class="keyword">DATE_FORMAT</span>( <span class="string">&#x27;2020-09-15 14:33:56.0&#x27;</span>, <span class="string">&#x27;%Y-%m-%d&#x27;</span>) <span class="keyword">and</span> <span class="keyword">DATE_FORMAT</span>( <span class="string">&#x27;2021-03-13 14:33:56.0&#x27;</span>, <span class="string">&#x27;%Y-%m-%d&#x27;</span>))</span><br><span class="line">	<span class="keyword">and</span> activity_id <span class="keyword">in</span> ( <span class="number">10187</span> , <span class="number">10343</span> , <span class="number">10345</span> , <span class="number">10346</span> , <span class="number">10347</span> , <span class="number">10348</span> )</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">	activity_id;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="2">
<li><p>活动概况</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">COUNT</span>(activity_id) <span class="keyword">as</span> activityTotal, <span class="keyword">count</span>(<span class="keyword">distinct</span> trial_brand_code) <span class="keyword">as</span> brandTotal, <span class="keyword">sum</span>(is_alert) <span class="keyword">as</span> activityAlertTotal, <span class="keyword">sum</span>(is_delay) <span class="keyword">as</span> activityDelayTotal, <span class="keyword">sum</span>(is_new_brand) <span class="keyword">as</span> newBrandTotal, <span class="keyword">sum</span>(is_new_brand)/<span class="keyword">count</span>(<span class="keyword">distinct</span> trial_brand_code) <span class="keyword">as</span> newBrandRatio</span><br><span class="line"> <span class="keyword">FROM</span> (</span><br><span class="line"> <span class="keyword">SELECT</span> activity_id, trial_brand_code, <span class="keyword">if</span>(<span class="keyword">sum</span>(is_alert)&gt;<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>) <span class="keyword">as</span> is_alert, <span class="keyword">if</span>(<span class="keyword">sum</span>(is_delay)&gt;<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>) <span class="keyword">as</span> is_delay, <span class="keyword">if</span>(<span class="keyword">sum</span>(is_new_brand)&gt;<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>) <span class="keyword">as</span> is_new_brand</span><br><span class="line"> <span class="keyword">FROM</span> board_activity</span><br><span class="line"> <span class="keyword">WHERE</span> send_type = <span class="number">1</span> <span class="keyword">and</span> activity_dt <span class="keyword">between</span> <span class="built_in">date</span>(<span class="string">&#x27;2021-03-14 00:00:00.0&#x27;</span>) <span class="keyword">and</span> <span class="built_in">date</span>(<span class="string">&#x27;2021-03-14 00:00:00.0&#x27;</span>) <span class="keyword">and</span> activity_dt <span class="keyword">between</span> <span class="built_in">date</span>(start_time) <span class="keyword">and</span> <span class="keyword">date_add</span>(end_time, <span class="built_in">interval</span> <span class="number">60</span> <span class="keyword">day</span>) <span class="keyword">group</span> <span class="keyword">by</span> activity_id )t;</span><br></pre></td></tr></table></figure>




</li>
</ol>
<p>趋势图</p>
<p>按周</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">DATE_FORMAT</span>(<span class="keyword">STR_TO_DATE</span>(<span class="keyword">CONCAT</span>(<span class="keyword">YEAR</span>(activity_dt),<span class="keyword">weekofyear</span>(activity_dt)<span class="number">-1</span>,<span class="string">&#x27;Monday&#x27;</span>) , <span class="string">&#x27;%X %V %W %u&#x27;</span>), <span class="string">&#x27;%Y-%m-%d&#x27;</span>) <span class="keyword">as</span> startActivityDt , <span class="keyword">DATE_FORMAT</span>(<span class="keyword">STR_TO_DATE</span>(<span class="keyword">CONCAT</span>(<span class="keyword">YEAR</span>(activity_dt),<span class="keyword">weekofyear</span>(activity_dt),<span class="string">&#x27;Sunday&#x27;</span>) , <span class="string">&#x27;%X %V %W %u&#x27;</span>), <span class="string">&#x27;%Y-%m-%d&#x27;</span>) <span class="keyword">as</span> endActivityDt , <span class="keyword">weekofyear</span>(activity_dt) periodNumber , <span class="keyword">sum</span>(real_send_count) <span class="keyword">as</span> realSendCount , <span class="keyword">sum</span>(send_income) <span class="keyword">as</span> sendIncome , <span class="keyword">sum</span>(send_efficiency)/<span class="keyword">count</span>(send_efficiency) <span class="keyword">as</span> sendRate</span><br><span class="line"> <span class="keyword">FROM</span> board_activity</span><br><span class="line"> <span class="keyword">WHERE</span> send_type = <span class="number">1</span> <span class="keyword">and</span> activity_dt <span class="keyword">between</span> <span class="built_in">date</span>(<span class="string">&#x27;2020-12-17 11:31:52.0&#x27;</span>) <span class="keyword">and</span> <span class="built_in">date</span>(<span class="string">&#x27;2021-03-16 11:31:52.0&#x27;</span>) <span class="keyword">and</span> activity_dt <span class="keyword">between</span> <span class="built_in">date</span>(start_time) <span class="keyword">and</span> <span class="keyword">date_add</span>(end_time, <span class="built_in">interval</span> <span class="number">60</span> <span class="keyword">day</span>) <span class="keyword">and</span> activity_id <span class="keyword">in</span> ( <span class="number">10187</span> , <span class="number">10343</span> , <span class="number">10345</span> , <span class="number">10346</span> , <span class="number">10347</span> , <span class="number">10348</span> ) <span class="keyword">and</span> distribution_model = <span class="number">0</span> <span class="keyword">group</span> <span class="keyword">by</span> periodNumber;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">STR_TO_DATE</span>(<span class="keyword">CONCAT</span>(<span class="keyword">YEAR</span>(activity_dt),weekPeriodNum<span class="number">-1</span>,<span class="string">&#x27;Monday&#x27;</span>) , <span class="string">&#x27;%X %V %W %u&#x27;</span>) <span class="keyword">as</span> startActivityDt , <span class="keyword">STR_TO_DATE</span>(<span class="keyword">CONCAT</span>(<span class="keyword">YEAR</span>(activity_dt),weekPeriodNum,<span class="string">&#x27;Sunday&#x27;</span>) , <span class="string">&#x27;%X %V %W %u&#x27;</span>) <span class="keyword">as</span> endActivityDt , weekPeriodNum <span class="keyword">as</span> periodNumber , activity_id <span class="keyword">as</span> activityId, <span class="keyword">if</span>(<span class="keyword">count</span>(<span class="keyword">distinct</span> user_log_acct)!=<span class="number">0</span>,<span class="keyword">count</span>(<span class="keyword">distinct</span> user_log_acct),<span class="number">0</span>) <span class="keyword">as</span> <span class="string">&#x27;sendUserCount&#x27;</span></span><br><span class="line"> <span class="keyword">FROM</span> board_activity_pin</span><br><span class="line"> <span class="keyword">WHERE</span> send_date <span class="keyword">between</span> <span class="built_in">date</span>(<span class="string">&#x27;2020-12-17 11:31:52.0&#x27;</span>) <span class="keyword">and</span> <span class="built_in">date</span>(<span class="string">&#x27;2021-03-16 11:31:52.0&#x27;</span>) <span class="keyword">and</span> send_type = <span class="number">1</span> <span class="keyword">and</span> activity_dt <span class="keyword">between</span> <span class="built_in">date</span>(<span class="string">&#x27;2020-12-17 11:31:52.0&#x27;</span>) <span class="keyword">and</span> <span class="built_in">date</span>(<span class="string">&#x27;2021-03-16 11:31:52.0&#x27;</span>) <span class="keyword">and</span> activity_dt <span class="keyword">between</span> <span class="built_in">date</span>(start_time) <span class="keyword">and</span> <span class="keyword">date_add</span>(end_time, <span class="built_in">interval</span> <span class="number">60</span> <span class="keyword">day</span>) <span class="keyword">and</span> activity_id <span class="keyword">in</span> ( <span class="number">10187</span> , <span class="number">10343</span> , <span class="number">10345</span> , <span class="number">10346</span> , <span class="number">10347</span> , <span class="number">10348</span> ) <span class="keyword">and</span> distribution_model = <span class="number">0</span> <span class="keyword">and</span> is_send_trial_sku = <span class="number">1</span> <span class="keyword">group</span> <span class="keyword">by</span> activity_id,periodNumber;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>活动看板下载</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">select</span></span><br><span class="line">activity_dt,</span><br><span class="line">activity_id,</span><br><span class="line">activity_name,</span><br><span class="line">distribution_model,</span><br><span class="line">create_by,</span><br><span class="line">trial_item_sku_id ,</span><br><span class="line">trial_brand_code ,</span><br><span class="line">trial_item_first_cate_name ,</span><br><span class="line">trial_item_second_cate_name ,</span><br><span class="line">trial_item_third_cate_name ,</span><br><span class="line">send_type ,</span><br><span class="line">activity_status ,</span><br><span class="line">plan_send_count ,</span><br><span class="line">real_send_count,</span><br><span class="line">send_efficiency ,</span><br><span class="line">send_income,</span><br><span class="line">real_send_user_count,</span><br><span class="line">sendCount,</span><br><span class="line"><span class="comment">-- sku相关 </span></span><br><span class="line">browsersku, addsku, dealsku, pvSku, browserSku/sendCount <span class="keyword">as</span> uvSkuRatio, addsku/browserSku <span class="keyword">as</span> addUVSkuRatio, addsku/dealsku <span class="keyword">as</span> addDealSkuRatio, dealsku/sendCount <span class="keyword">as</span> dealSkuRatio, dealSkuCount, dealSkuPrice, dealSkuPrice/browsersku <span class="keyword">as</span> skuUvPrice, dealSkuPrice/dealSku <span class="keyword">as</span> skuDealUserValue, </span><br><span class="line"><span class="comment">-- brand相关</span></span><br><span class="line"> browserbrand, addbrand, dealbrand, pvBrand, browserbrand/sendCount <span class="keyword">as</span> uvBrandRatio, addbrand/browserbrand <span class="keyword">as</span> addUVBrandRatio, addbrand/dealbrand <span class="keyword">as</span> addDealBrandRatio, dealbrand/sendCount <span class="keyword">as</span> dealBrandRatio, dealBrandCount, dealBrandPrice, dealBrandPrice/browserbrand <span class="keyword">as</span> brandUvPrice, dealBrandPrice/dealBrand <span class="keyword">as</span> brandDealUserValue, </span><br><span class="line"> <span class="comment">-- 新老用户相关 </span></span><br><span class="line"> newDealUser, oldDealUser, awakenDealUser, newDealUser/dealbrand <span class="keyword">as</span> newDealUserRatio, oldDealUser/dealbrand <span class="keyword">as</span> oldDealUserRatio, awakenDealUser/dealbrand <span class="keyword">as</span> awakenDealUserRatio, newDealCount, oldDealCount, awakenDealCount, newDealCount/dealBrandCount <span class="keyword">as</span> newDealCountRatio, oldDealCount/dealBrandCount <span class="keyword">as</span> awakenDealCountRatio, awakenDealCount/dealBrandCount <span class="keyword">as</span> awakenDealCountRatio, newDealPrice, oldDealPrice, awakenDealPrice, newDealPrice/dealBrandPrice <span class="keyword">as</span> newDealPriceRatio, oldDealPrice/dealBrandPrice <span class="keyword">as</span> oldDealPriceRatio, awakenDealPrice/dealBrandPrice <span class="keyword">as</span> awakenDealPriceRatio, newDealPrice/newDealUser <span class="keyword">as</span> newUvValue, oldDealPrice/oldDealUser <span class="keyword">as</span> oldUvValue, awakenDealPrice/awakenDealUser <span class="keyword">as</span> awakenUvValue</span><br><span class="line">   </span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	a.activity_dt, a.activity_id, a.activity_name, a.distribution_model, a.create_by, a.trial_item_sku_id, a.trial_brand_code , a.trial_item_first_cate_name , a.trial_item_second_cate_name , a.trial_item_third_cate_name , a.send_type , a.activity_status , a.plan_send_count_day <span class="keyword">as</span> plan_send_count , a.real_send_count, a.send_efficiency , a.send_income, a.real_send_user_count, real_send_user_count <span class="keyword">as</span> sendCount,</span><br><span class="line">	<span class="comment">-- sku维度 </span></span><br><span class="line">	<span class="keyword">sum</span>(is_browser_target_sku) <span class="keyword">as</span> browserSku, <span class="keyword">sum</span>(is_add_cart_target_sku) <span class="keyword">as</span> addSku, <span class="keyword">sum</span>(is_deal_target_sku) <span class="keyword">as</span> dealSku, <span class="keyword">sum</span>(browser_target_sku_num) <span class="keyword">as</span> pvSku, <span class="keyword">sum</span>(target_sku_sale_qtty) <span class="keyword">as</span> dealSkuCount, <span class="keyword">sum</span>(target_sku_amount) <span class="keyword">as</span> dealSkuPrice, </span><br><span class="line">	<span class="comment">-- brand维度 </span></span><br><span class="line">	<span class="keyword">sum</span>(is_browser_target_brand) <span class="keyword">as</span> browserbrand, <span class="keyword">sum</span>(is_add_cart_target_brand) <span class="keyword">as</span> addbrand, <span class="keyword">sum</span>(is_deal_target_brand) <span class="keyword">as</span> dealbrand, <span class="keyword">sum</span>(browser_target_brand_num) <span class="keyword">as</span> pvBrand, <span class="keyword">sum</span>(target_brand_sale_qtty) <span class="keyword">as</span> dealBrandCount, <span class="keyword">sum</span>(target_brand_amount) <span class="keyword">as</span> dealBrandPrice, </span><br><span class="line">	<span class="comment">-- 新老客维度 </span></span><br><span class="line">	<span class="keyword">sum</span>(<span class="keyword">if</span>(user_type = <span class="number">3</span> <span class="keyword">and</span> is_deal_target_brand = <span class="number">1</span>, <span class="number">1</span> ,<span class="number">0</span>)) <span class="keyword">as</span> newDealUser, <span class="keyword">sum</span>(<span class="keyword">if</span>(user_type = <span class="number">2</span> <span class="keyword">and</span> is_deal_target_brand = <span class="number">1</span>, <span class="number">1</span> ,<span class="number">0</span>)) <span class="keyword">as</span> oldDealUser, <span class="keyword">sum</span>(<span class="keyword">if</span>(user_type = <span class="number">1</span> <span class="keyword">and</span> is_deal_target_brand = <span class="number">1</span>, <span class="number">1</span> ,<span class="number">0</span>)) <span class="keyword">as</span> awakenDealUser, <span class="keyword">sum</span>(<span class="keyword">if</span>(user_type = <span class="number">3</span> <span class="keyword">and</span> is_deal_target_brand = <span class="number">1</span>, target_brand_sale_qtty ,<span class="number">0</span>)) <span class="keyword">as</span> newDealCount, <span class="keyword">sum</span>(<span class="keyword">if</span>(user_type = <span class="number">2</span> <span class="keyword">and</span> is_deal_target_brand = <span class="number">1</span>, target_brand_sale_qtty ,<span class="number">0</span>)) <span class="keyword">as</span> oldDealCount, <span class="keyword">sum</span>(<span class="keyword">if</span>(user_type = <span class="number">1</span> <span class="keyword">and</span> is_deal_target_brand = <span class="number">1</span>, target_brand_sale_qtty ,<span class="number">0</span>)) <span class="keyword">as</span> awakenDealCount, <span class="keyword">sum</span>(<span class="keyword">if</span>(user_type = <span class="number">3</span> <span class="keyword">and</span> is_deal_target_brand = <span class="number">1</span>, target_brand_amount ,<span class="number">0</span>)) <span class="keyword">as</span> newDealPrice, <span class="keyword">sum</span>(<span class="keyword">if</span>(user_type = <span class="number">2</span> <span class="keyword">and</span> is_deal_target_brand = <span class="number">1</span>, target_brand_amount ,<span class="number">0</span>)) <span class="keyword">as</span> oldDealPrice, <span class="keyword">sum</span>(<span class="keyword">if</span>(user_type = <span class="number">1</span> <span class="keyword">and</span> is_deal_target_brand = <span class="number">1</span>, target_brand_amount ,<span class="number">0</span>)) <span class="keyword">as</span> awakenDealPrice</span><br><span class="line">   </span><br><span class="line">	<span class="keyword">from</span> board_activity a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> board_activity_pin b <span class="keyword">on</span></span><br><span class="line">	a.activity_id = b.activity_id</span><br><span class="line">	<span class="keyword">and</span> a.activity_dt = b.activity_dt</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">	a.activity_dt <span class="keyword">between</span> <span class="built_in">date</span>(<span class="string">&#x27;2021-01-03 17:03:44.0&#x27;</span>) <span class="keyword">and</span> <span class="built_in">date</span>(<span class="string">&#x27;2021-04-05 17:03:44.0&#x27;</span>)</span><br><span class="line">	<span class="keyword">and</span> a.activity_id = <span class="number">10343</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">	a.activity_dt ) t;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h2 id="八-上线准备"><a href="#八-上线准备" class="headerlink" title="八.上线准备"></a>八.上线准备</h2><p>1.DB</p>
<blockquote>
<p>push-table:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- upmp2_2.board_push_data_finish definition</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`board_push_data_finish`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;自增主键&#x27;</span>,</span><br><span class="line">  <span class="string">`table_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">  <span class="string">`dt`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;分区时间&#x27;</span>,</span><br><span class="line">  <span class="string">`modify_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;记录更新时间&#x27;</span>,</span><br><span class="line">  <span class="string">`sharding_end_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;分表结束时间&#x27;</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_table_name`</span> (<span class="string">`table_name`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">&#x27;大数据推送数据任务结束记录表&#x27;</span>;</span><br></pre></td></tr></table></figure>

</blockquote>
<ol start="2">
<li>原Important.properties</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config.db.url&#x3D;qCx3UZJP7NrJy0JGgUGdapzQcojzITi4rjf+mzU8MKzS7d5chqK1588IfpkDy1&#x2F;c+IgykLZXLC2ZiTI2n56PY&#x2F;6EnGlQALGxRvH84WKWzA3f8bLE9Kj9PCV+qjlbB&#x2F;YWnvcakd6OFTjLXE0ITtWEE2oqV&#x2F;m+MbvR+9IhJYcWCJ0XlaSrRRaP0mT4o2opoItx99dOvKSLuaQ&#x3D;</span><br><span class="line">config.db.user&#x3D;DpyhJf6LgXhxG0Wx52vT0g&#x3D;&#x3D;</span><br><span class="line">config.db.password&#x3D;QbdACsHDu8N6vyVWCVfKZgn6&#x2F;P7zKw80B+mvpzTreIaIX3WASTQZ2g&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>上线版本 Important.properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">config.dynamic.datasource.db.url&#x3D;qCx3UZJP7NrJy0JGgUGdapzQcojzITi4rjf+mzU8MKzS7d5chqK1588IfpkDy1&#x2F;c+IgykLZXLC2ZiTI2n56PY&#x2F;6EnGlQALGxRvH84WKWzA3f8bLE9Kj9PCV+qjlbB&#x2F;YWnvcakd6OFTjLXE0ITtWEE2oqV&#x2F;m+MbvR+9IhJYcWCJ0XlaSrRRaP0mT4o2opoItx99dOvKSLuaQ&#x3D;</span><br><span class="line">config.dynamic.datasource.db.username&#x3D;DpyhJf6LgXhxG0Wx52vT0g&#x3D;&#x3D;</span><br><span class="line">config.dynamic.datasource.db.password&#x3D;QbdACsHDu8N6vyVWCVfKZgn6&#x2F;P7zKw80B+mvpzTreIaIX3WASTQZ2g&#x3D;&#x3D;</span><br><span class="line">config.dynamic.datasource.db2.url&#x3D;qCx3UZJP7NrJy0JGgUGdai7c0b0b94aFrjf+mzU8MKzS7d5chqK155sluPIDxt40IdlecjHkp3c879DmniXhoENB+Y3cXBNRRk6o8cGVIBzV&#x2F;+NVikmhPfJL2mTPV3i1LkBL93WSK0HifTOMPVCtBWLs3O7Sr&#x2F;M5+ZeEo&#x2F;apxHgGfsB7nFTYg+pKTLoFChI7Mp8h7L4rZyM&#x3D;</span><br><span class="line">config.dynamic.datasource.db2.username&#x3D;UXuh4jNyIJtTrCkF&#x2F;OKQzQ&#x3D;&#x3D;</span><br><span class="line">config.dynamic.datasource.db2.password&#x3D;NFSo7ao35&#x2F;KpnWFnEJMe1RvurQ21tcJFe82bhm95+iOIX3WASTQZ2g&#x3D;&#x3D;</span><br><span class="line">config.dynamic.datasource.db2-slave0.url&#x3D;qCx3UZJP7NrJy0JGgUGdaow9QH61TqSh2MwGb2YH&#x2F;gy2ndCV5iounYlh2jUz2zsMaHn9XNamaElAzn1xZ4O4&#x2F;bY9PfjIrnRMrXmJZZHwyIsp9Op4ROWSPVi5HFzJN+H0J5P2tBg0fU&#x2F;qou&#x2F;64h4GGxjTGLXhzn9&#x2F;8Q694NsuvTMKpV2fc0&#x2F;BQFWiyP+x&#x2F;SfCk6lNiz9xPho&#x3D;</span><br><span class="line">config.dynamic.datasource.db2-slave0.username&#x3D;UXuh4jNyIJtTrCkF&#x2F;OKQzQ&#x3D;&#x3D;</span><br><span class="line">config.dynamic.datasource.db2-slave0.password&#x3D;NFSo7ao35&#x2F;KpnWFnEJMe1RvurQ21tcJFe82bhm95+iOIX3WASTQZ2g&#x3D;&#x3D;</span><br><span class="line">config.dynamic.datasource.db2-slave1.url&#x3D;qCx3UZJP7NrJy0JGgUGdaroPSdhXq&#x2F;od2MwGb2YH&#x2F;gy2ndCV5iounYlh2jUz2zsMaHn9XNamaElAzn1xZ4O4&#x2F;bY9PfjIrnRMrXmJZZHwyIsp9Op4ROWSPVi5HFzJN+H0J5P2tBg0fU&#x2F;qou&#x2F;64h4GGxjTGLXhzn9&#x2F;8Q694NsuvTMKpV2fc0&#x2F;BQFWiyP+x&#x2F;SfCk6lNiz9xPho&#x3D;</span><br><span class="line">config.dynamic.datasource.db2-slave1.username&#x3D;UXuh4jNyIJtTrCkF&#x2F;OKQzQ&#x3D;&#x3D;</span><br><span class="line">config.dynamic.datasource.db2-slave1.password&#x3D;NFSo7ao35&#x2F;KpnWFnEJMe1RvurQ21tcJFe82bhm95+iOIX3WASTQZ2g&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>预发环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">config.dynamic.datasource.db.url&#x3D;qCx3UZJP7NoCgsWMq5VKVjk0NH3rSg0n6XN1mQiXskjGCZKAIER&#x2F;Blpk0&#x2F;pRZYS45Kl0yHhYXukKkbnqVCkMUKc+Z4Vkj5I1EX2&#x2F;xcPCk8D&#x2F;gxtHon&#x2F;g&#x2F;LBNuGqq7WpJF69LJ+L6HJvTlGfQndy68MtxDpwV4wxIXn7uLEBWfn&#x2F;dpb185O9MyQcSg&#x2F;m1FQXv4Py&#x2F;iRS1xqU&#x3D;</span><br><span class="line">config.dynamic.datasource.db.username&#x3D;bF7W&#x2F;r38nAW&#x2F;pc2XeBPWLA&#x3D;&#x3D;</span><br><span class="line">config.dynamic.datasource.db.password&#x3D;LQuDj75IKIzsX6Xh85KXyYhfdYBJNBna</span><br><span class="line">config.dynamic.datasource.db2.username&#x3D;UXuh4jNyIJs2nYplsM&#x2F;iIv7nWEU0EWwz</span><br><span class="line">config.dynamic.datasource.db2.password&#x3D;mZ14PvmtWY3s44ytD4+fBIhfdYBJNBna</span><br><span class="line">config.dynamic.datasource.db2.url&#x3D;qCx3UZJP7NoCgsWMq5VKVk+KtLZBXBRofx+eQ3cdz7+YNz6aUfcUneBwwDmwmW7m+qXfOLcNSG&#x2F;d+6BhD+ead7za8+38voCOrPiyrYzOudFyOW08FUYI29UchJK82b5btY5xVNPonGpSA3p9zucqI39DlZ+rpn0mskgkMN5lb0TnLcvtIraWtBddG7tshONr54wo4w73WEuIX3WASTQZ2g&#x3D;&#x3D;</span><br><span class="line">config.dynamic.datasource.db2-slave0.username&#x3D;UXuh4jNyIJs2nYplsM&#x2F;iIv7nWEU0EWwz</span><br><span class="line">config.dynamic.datasource.db2-slave0.password&#x3D;mZ14PvmtWY3s44ytD4+fBIhfdYBJNBna</span><br><span class="line">config.dynamic.datasource.db2-slave0.url&#x3D;qCx3UZJP7NoCgsWMq5VKVk+KtLZBXBRofx+eQ3cdz7+YNz6aUfcUneBwwDmwmW7m+qXfOLcNSG&#x2F;d+6BhD+ead7za8+38voCOrPiyrYzOudFyOW08FUYI29UchJK82b5btY5xVNPonGpSA3p9zucqI39DlZ+rpn0mskgkMN5lb0TnLcvtIraWtBddG7tshONr54wo4w73WEuIX3WASTQZ2g&#x3D;&#x3D;</span><br><span class="line">config.dynamic.datasource.db2-slave1.username&#x3D;UXuh4jNyIJs2nYplsM&#x2F;iIv7nWEU0EWwz</span><br><span class="line">config.dynamic.datasource.db2-slave1.password&#x3D;mZ14PvmtWY3s44ytD4+fBIhfdYBJNBna</span><br><span class="line">config.dynamic.datasource.db2-slave1.url&#x3D;qCx3UZJP7NoCgsWMq5VKVk+KtLZBXBRofx+eQ3cdz7+YNz6aUfcUneBwwDmwmW7m+qXfOLcNSG&#x2F;d+6BhD+ead7za8+38voCOrPiyrYzOudFyOW08FUYI29UchJK82b5btY5xVNPonGpSA3p9zucqI39DlZ+rpn0mskgkMN5lb0TnLcvtIraWtBddG7tshONr54wo4w73WEuIX3WASTQZ2g&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>




</li>
</ol>
</li>
</ol>
<h2 id="九-性能优化"><a href="#九-性能优化" class="headerlink" title="九. 性能优化"></a>九. 性能优化</h2><h3 id="1-业务优化"><a href="#1-业务优化" class="headerlink" title="1.业务优化"></a>1.业务优化</h3><ol>
<li><p>总数据量   –  8665340（2021-01-01 – 2021-03-29）</p>
</li>
<li><p>派发无用数据总量</p>
<p>试用品量级 – 3892915</p>
<p>话卡量级 – 4772425</p>
</li>
<li><p>派发无用数据 – 5586342  其中试用品 1652782，话卡3933560</p>
<table>
<thead>
<tr>
<th>2021.01.01-2021.03.29</th>
<th>总量</th>
<th>派发数据</th>
<th>转化数据</th>
<th>修改后可减少数据比率</th>
</tr>
</thead>
<tbody><tr>
<td>汇总</td>
<td>8665340</td>
<td>5589342</td>
<td>3078998</td>
<td>64%</td>
</tr>
<tr>
<td>试用品</td>
<td>3892915</td>
<td>1652782</td>
<td>2240133</td>
<td>42%</td>
</tr>
<tr>
<td>话卡</td>
<td>4772425</td>
<td>3933560</td>
<td>838865</td>
<td>82%</td>
</tr>
<tr>
<td>预估一年</td>
<td>2700w</td>
<td>1600w</td>
<td>1100w</td>
<td>60%</td>
</tr>
</tbody></table>
</li>
</ol>
<h3 id="2-索引优化"><a href="#2-索引优化" class="headerlink" title="2.索引优化"></a>2.索引优化</h3>   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 加购用户</span></span><br><span class="line"><span class="keyword">explain</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	activity_id ,</span><br><span class="line">	<span class="keyword">count</span>(user_log_acct)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">	board_activity_pin</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line"><span class="comment">-- send_date between date(&#x27;2021-01-01 21:05:29.0&#x27;) and date(&#x27;2021-03-29 21:05:29.0&#x27;)</span></span><br><span class="line"><span class="comment">-- and </span></span><br><span class="line">	activity_id <span class="keyword">in</span> ( <span class="number">10030</span> , <span class="number">10034</span> , <span class="number">10039</span> , <span class="number">10052</span> , <span class="number">10055</span> , <span class="number">10058</span> , <span class="number">10059</span> , <span class="number">10060</span> , <span class="number">10062</span> , <span class="number">10063</span> , <span class="number">10066</span> , <span class="number">10105</span> , <span class="number">10151</span> , <span class="number">10152</span> , <span class="number">10153</span> , <span class="number">10155</span> , <span class="number">10156</span> , <span class="number">10157</span> , <span class="number">10158</span> , <span class="number">10159</span> , <span class="number">10160</span> , <span class="number">10187</span> , <span class="number">10191</span> , <span class="number">10193</span> , <span class="number">10195</span> , <span class="number">10200</span> , <span class="number">10208</span> , <span class="number">10212</span> , <span class="number">10214</span> , <span class="number">10219</span> , <span class="number">10222</span> , <span class="number">10239</span> , <span class="number">10241</span> , <span class="number">10242</span> , <span class="number">10246</span> , <span class="number">10248</span> , <span class="number">10249</span> , <span class="number">10250</span> , <span class="number">10252</span> , <span class="number">10253</span> , <span class="number">10254</span> , <span class="number">10255</span> , <span class="number">10261</span> , <span class="number">10262</span> , <span class="number">10283</span> , <span class="number">10284</span> , <span class="number">10286</span> , <span class="number">10294</span> , <span class="number">10295</span> , <span class="number">10297</span> , <span class="number">10298</span> , <span class="number">10299</span> , <span class="number">10300</span> , <span class="number">10314</span> , <span class="number">10317</span> , <span class="number">10318</span> , <span class="number">10319</span> , <span class="number">10320</span> , <span class="number">10321</span> , <span class="number">10327</span> , <span class="number">10328</span> , <span class="number">10331</span> , <span class="number">10337</span> , <span class="number">10339</span> , <span class="number">10341</span> , <span class="number">10343</span> , <span class="number">10345</span> , <span class="number">10346</span> , <span class="number">10347</span> , <span class="number">10348</span> , <span class="number">10350</span> , <span class="number">10354</span> , <span class="number">10364</span> , <span class="number">10365</span> , <span class="number">10366</span> , <span class="number">10367</span> , <span class="number">10368</span> , <span class="number">10369</span> , <span class="number">10370</span> , <span class="number">10371</span> , <span class="number">10379</span> , <span class="number">10389</span> , <span class="number">10392</span> , <span class="number">10394</span> , <span class="number">10398</span> , <span class="number">10402</span> , <span class="number">10403</span> , <span class="number">10405</span> , <span class="number">10407</span> , <span class="number">10408</span> , <span class="number">10409</span> , <span class="number">10418</span> , <span class="number">10419</span> , <span class="number">10420</span> , <span class="number">10424</span> , <span class="number">10425</span> , <span class="number">10426</span> , <span class="number">10428</span> , <span class="number">10429</span> , <span class="number">10430</span> , <span class="number">10431</span> , <span class="number">10434</span> , <span class="number">10436</span> , <span class="number">10437</span> , <span class="number">10438</span> , <span class="number">10439</span> , <span class="number">10440</span> , <span class="number">10441</span> , <span class="number">10442</span> , <span class="number">10444</span> , <span class="number">10445</span> , <span class="number">10446</span> , <span class="number">10450</span> , <span class="number">10451</span> , <span class="number">10452</span> , <span class="number">10454</span> , <span class="number">10465</span> , <span class="number">10466</span> , <span class="number">10468</span> , <span class="number">10469</span> , <span class="number">10471</span> , <span class="number">10472</span> , <span class="number">10473</span> , <span class="number">10474</span> , <span class="number">10475</span> , <span class="number">10486</span> , <span class="number">10516</span> , <span class="number">10525</span> , <span class="number">10554</span> , <span class="number">10555</span> , <span class="number">10570</span> , <span class="number">10599</span> , <span class="number">10605</span> , <span class="number">10615</span> , <span class="number">10667</span> , <span class="number">10668</span> , <span class="number">10679</span> , <span class="number">10680</span> , <span class="number">10681</span> , <span class="number">10705</span> , <span class="number">10706</span> , <span class="number">10707</span> , <span class="number">10744</span> , <span class="number">10748</span> , <span class="number">10793</span> , <span class="number">10806</span> , <span class="number">10826</span> , <span class="number">10832</span> , <span class="number">10861</span> , <span class="number">10873</span> , <span class="number">10874</span> , <span class="number">10885</span> , <span class="number">10886</span> , <span class="number">10887</span> , <span class="number">10888</span> , <span class="number">10889</span> , <span class="number">10895</span> , <span class="number">10896</span> , <span class="number">10906</span> , <span class="number">10907</span> , <span class="number">10908</span> , <span class="number">10909</span> , <span class="number">10912</span> , <span class="number">10922</span> , <span class="number">10924</span> , <span class="number">10925</span> , <span class="number">10929</span> , <span class="number">10937</span> , <span class="number">10938</span> , <span class="number">10964</span> , <span class="number">10966</span> , <span class="number">10973</span> , <span class="number">10974</span> , <span class="number">10976</span> , <span class="number">10977</span> , <span class="number">10978</span> , <span class="number">10980</span> , <span class="number">10981</span> , <span class="number">10983</span> , <span class="number">10985</span> , <span class="number">10991</span> , <span class="number">10992</span> , <span class="number">10993</span> , <span class="number">10997</span> , <span class="number">10999</span> , <span class="number">11000</span> , <span class="number">11001</span> , <span class="number">11008</span> , <span class="number">11009</span> , <span class="number">11011</span> , <span class="number">11012</span> , <span class="number">11013</span> , <span class="number">11014</span> , <span class="number">11017</span> , <span class="number">11019</span> , <span class="number">11020</span> , <span class="number">11021</span> , <span class="number">11023</span> , <span class="number">11025</span> , <span class="number">11026</span> , <span class="number">11027</span> , <span class="number">11032</span> , <span class="number">11034</span> , <span class="number">11052</span> , <span class="number">11054</span> , <span class="number">11056</span> , <span class="number">11057</span> , <span class="number">11058</span> , <span class="number">11065</span> , <span class="number">11068</span> , <span class="number">11069</span> , <span class="number">11072</span> , <span class="number">11075</span> , <span class="number">11078</span> , <span class="number">11082</span> , <span class="number">11085</span> , <span class="number">11086</span> , <span class="number">11089</span> , <span class="number">11090</span> , <span class="number">11092</span> , <span class="number">11094</span> , <span class="number">11096</span> , <span class="number">11097</span> , <span class="number">11098</span> , <span class="number">11099</span> , <span class="number">11100</span> , <span class="number">11101</span> , <span class="number">11102</span> , <span class="number">11103</span> , <span class="number">11104</span> , <span class="number">11105</span> , <span class="number">11106</span> , <span class="number">11107</span> , <span class="number">11108</span> , <span class="number">11112</span> , <span class="number">11114</span> , <span class="number">11115</span> , <span class="number">11116</span> , <span class="number">11117</span> , <span class="number">11120</span> , <span class="number">11125</span> , <span class="number">11130</span> , <span class="number">11132</span> , <span class="number">11133</span> , <span class="number">11144</span> , <span class="number">11147</span> , <span class="number">11151</span> , <span class="number">11154</span> , <span class="number">11155</span> , <span class="number">11156</span> , <span class="number">11158</span> , <span class="number">11162</span> , <span class="number">11166</span> , <span class="number">11167</span> , <span class="number">11168</span> )</span><br><span class="line"></span><br><span class="line"><span class="keyword">and</span> activity_dt <span class="keyword">between</span> <span class="built_in">date</span>(<span class="string">&#x27;2021-01-01 21:05:29.0&#x27;</span>) <span class="keyword">and</span> <span class="built_in">date</span>(<span class="string">&#x27;2021-03-29 21:05:29.0&#x27;</span>)</span><br><span class="line"><span class="comment">-- and activity_dt between date(start_time) and date_add(end_time, interval 60 day)</span></span><br><span class="line"><span class="comment">-- and is_browser_target_brand = 1</span></span><br><span class="line"><span class="comment">-- and is_add_cart_target_brand = 1</span></span><br><span class="line"><span class="comment">-- and is_add_cart_target_sku = 1</span></span><br><span class="line"><span class="keyword">and</span> is_browser_target_sku = <span class="number">1</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">	activity_id;</span><br></pre></td></tr></table></figure>

<p>   建立如下索引，没走，效率巨慢有10s+</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table board_activity_pin add index idx_browser_sku(activity_id,activity_dt,start_time,end_time,user_log_acct,is_browser_target_sku);</span><br></pre></td></tr></table></figure>

<p>建立如下索引，走索引，有1.78s</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> board_activity_pin <span class="keyword">add</span> <span class="keyword">index</span> idx_browser_sku(activity_id,user_log_acct,is_browser_target_sku,activity_dt,start_time,end_time);</span><br></pre></td></tr></table></figure>

<p>建立如下索引，走索引，有600ms</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> board_activity_pin <span class="keyword">add</span> <span class="keyword">index</span> idx_browser_sku(activity_id,is_browser_target_sku,user_log_acct,activity_dt,start_time,end_time);</span><br></pre></td></tr></table></figure>

<p>建立如下索引，不走索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> board_activity_pin <span class="keyword">add</span> <span class="keyword">index</span> idx_browser_sku(activity_id,is_browser_target_sku,activity_dt,start_time,end_time,user_log_acct);</span><br></pre></td></tr></table></figure>

<p><strong>索引优化后续：</strong> </p>
<p>1.和数据量，数据区别度有关。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> board_activity_pin <span class="keyword">add</span> <span class="keyword">index</span> idx_browser_sku(is_browser_target_sku,activity_id,activity_dt,user_log_acct);</span><br></pre></td></tr></table></figure>

<p>2.后续发现300w的量在内存里count( distinct  user_log_acct )</p>
<p>发现explain不走range，走的是ref –&gt;const,是DB选择了最优方式，但还是效率不行。==最后选择业务切片，缩小数据量==。</p>
<p><strong>说明：</strong></p>
<ol>
<li>最左前缀匹配原则，非常重要的原则，</li>
</ol>
<ul>
<li>mysql会一直向右匹配直到遇到范围查询(&gt;、&lt;、between、like)就停止匹配，</li>
<li>比如a = 1 and b = 2 and c &gt; 3 and d = 4<ul>
<li>如果建立(a,b,c,d)顺序的索引，d是用不到索引的，</li>
<li>如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整（建立索引时他们三个的顺序）</li>
</ul>
</li>
</ul>
<p>如上，activity_dt必须建立在后面，影响索引使用长度</p>
<ol start="2">
<li><p>user_log_acct计算字段其实不走索引，只是在索引中把该字段计算了一遍，因此位置应后置</p>
</li>
<li><p>start_time,end_time 理论上不走索引的，因为前置有函数。</p>
</li>
<li><p>最后和数据侧从业务上排查，start_time无需使用筛选，数据侧保证。150ms出结果。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> board_activity_pin <span class="keyword">add</span> <span class="keyword">index</span> idx_browser_sku(activity_id,is_browser_target_sku,activity_dt,user_log_acct);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>补充：</strong></p>
<h4 id="建索引的几大原则"><a href="#建索引的几大原则" class="headerlink" title="建索引的几大原则"></a>建索引的几大原则</h4><ul>
<li>1.最左前缀匹配原则，非常重要的原则，<ul>
<li>mysql会一直向右匹配直到遇到范围查询(&gt;、&lt;、between、like)就停止匹配，</li>
<li>比如a = 1 and b = 2 and c &gt; 3 and d = 4<ul>
<li>如果建立(a,b,c,d)顺序的索引，d是用不到索引的，</li>
<li>如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整（建立索引时他们三个的顺序）</li>
</ul>
</li>
</ul>
</li>
<li>2.=和in可以乱序，<ul>
<li>比如a = 1 and b = 2 and c = 3 建立(a,b,c)索引<strong>可以任意顺序</strong>，</li>
<li>mysql的查询优化器会帮你优化成索引可以识别的形式。</li>
</ul>
</li>
<li>3.尽量选择区分度高的列作为索引，<ul>
<li>区分度的公式是count(distinct col)/count(*)，表示字段不重复的比例，<ul>
<li>比例越大我们扫描的记录数越少，唯一键的区分度是1，</li>
<li>而一些状态、性别字段可能在大数据面前区分度就是0，</li>
<li>那可能有人会问，这个比例有什么经验值吗？<ul>
<li>使用场景不同，这个值也很难确定，一般需要join的字段我们都要求是0.1以上，即平均1条扫描10条记录。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>4.<strong>索引列不能参与计算，保持列“干净”</strong>，<ul>
<li>比如from_unixtime(create_time) = ’2014-05-29’就不能使用到索引，</li>
<li>原因很简单，b+树中存的都是数据表中的字段值，但进行检索时，需要把所有元素都<strong>应用函数才能比较，显然成本太大</strong>。<ul>
<li>所以语句应该写成create_time = unix_timestamp(’2014-05-29’)</li>
</ul>
</li>
</ul>
</li>
<li>5.尽量的扩展索引，不要新建索引。<ul>
<li>比如表中已经有a的索引，现在要加(a,b)的索引，那么只需要修改原来的索引即可。</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=https://tech.meituan.com/2014/06/30/mysql-index.html">https://tech.meituan.com/2014/06/30/mysql-index.html</a>   </p>
<h3 id="3-线程池使用"><a href="#3-线程池使用" class="headerlink" title="3. 线程池使用"></a>3. 线程池使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTaskUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ThreadFactory threadFactory = <span class="keyword">new</span> ThreadFactoryBuilder().setNameFormat(<span class="string">&quot;async-task-util-%d&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ExecutorService executorService = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">30</span>, <span class="number">540</span>, <span class="number">0</span>,</span><br><span class="line">            TimeUnit.SECONDS, <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">1000</span>),</span><br><span class="line">            threadFactory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">executeTaskList</span><span class="params">(List&lt;Callable&lt;T&gt;&gt; taskList, <span class="keyword">long</span> taskTimeOutSecs)</span> </span>&#123;</span><br><span class="line">        List&lt;Future&lt;T&gt;&gt; futures = Lists.newArrayList();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;T&gt; resList = Lists.newArrayList();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> taskSize = taskList.size();</span><br><span class="line">            <span class="keyword">for</span> (Callable&lt;T&gt; tCallable : taskList) &#123;</span><br><span class="line">                Future&lt;T&gt; future = executorService.submit(tCallable);</span><br><span class="line">                futures.add(future);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; taskSize; i++) &#123;</span><br><span class="line">                T res = futures.get(i).get(taskTimeOutSecs, TimeUnit.SECONDS);</span><br><span class="line">                resList.add(res);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> resList;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;执行异步任务失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Future f : futures) &#123;</span><br><span class="line">                f.cancel(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p> List&lt;Future<T>&gt; futures 保证顺序，以最后一个任务时间未结束时间。</p>
</li>
<li><pre><code>class StatExecutor implements Callable
用好构造函数，但需保证无公用属性。多线程大忌。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">3.  子线程中可再起 子线程，但需注意传递属性时不能使用父类公用属性，后期就变量值错乱。</span><br><span class="line"></span><br><span class="line">   注意静态对象和单例对象。</span><br><span class="line"></span><br><span class="line">## 十. 线上问题总结</span><br><span class="line"></span><br><span class="line">#### 1.hikari线程池</span><br><span class="line"></span><br><span class="line">最小空闲数设置为100，最大为300。导致报错too many connect、</span><br><span class="line"></span><br><span class="line">hikari官方文档不建议设置最小空闲数，默认和最大线程数相同，同时默认为10个。</span><br><span class="line"></span><br><span class="line">最大线程数也不是设置越多越好，受限于磁盘IO，网络带宽限制。默认core*2+1.</span><br><span class="line"></span><br><span class="line">[about pool size](https:&#x2F;&#x2F;github.com&#x2F;brettwooldridge&#x2F;HikariCP&#x2F;wiki&#x2F;About-Pool-Sizing)</span><br><span class="line"></span><br><span class="line">动态数据源时，默认连接的是主库数据源的连接，由下图连接数可得。</span><br><span class="line"></span><br><span class="line">#### 2.mysql 最大連接數</span><br><span class="line"></span><br><span class="line">当天几台服务器没起来，查看当时max connect，db1-- 2000  db2--2700</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;sql</span><br><span class="line">show global status like &#39;Max_used_connections&#39;;</span><br><span class="line"></span><br><span class="line">show variables like &#39;%max_connections%&#39;;</span><br><span class="line">show status like &#39;Threads%&#39;;  </span><br><span class="line">   mysql&gt; show status like &#39;Threads%&#39;;  </span><br><span class="line">    +-------------------+-------+  </span><br><span class="line">    | Variable_name     | Value |  </span><br><span class="line">    +-------------------+-------+  </span><br><span class="line">    | Threads_cached    | 58    |  </span><br><span class="line">    | Threads_connected | 57    |   ###这个数值指的是打开的连接数  </span><br><span class="line">    | Threads_created   | 3676  |  </span><br><span class="line">    | Threads_running   | 4     |   ###这个数值指的是激活的连接数，这个数值一般远低于connected数值  </span><br><span class="line">SHOW STATUS LIKE &#39;%Connection%&#39;; </span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ol>
<p>上线当晚，DB1默认数据库启动了连接数10000+，导致部分机器连接数据库失败。</p>
<p><img src="https://i.loli.net/2021/04/18/DrHQSzhmgnaXbEx.png" alt="image-20210418192158145"></p>
<p>当晚2.38机器更新最小配置数，恢复正常。</p>
<p><img src="https://i.loli.net/2021/04/18/2MsdqVc74yaIvzx.png" alt="image-20210418192416127"></p>
<p>记录1.40刻，db1–10000  db2–4000 db2-s1 2400 db2-s2 2700 (后续仍需关注启动连接数)</p>
<p>查看可得db2目前已恢复平均600左右。（max-connect达到5701，后续仍需关注）</p>
<p>目前db1 恢复在1500左右。</p>
<h4 id="3-TCP连接数"><a href="#3-TCP连接数" class="headerlink" title="3. TCP连接数"></a>3. TCP连接数</h4><p>一台机器最大究竟能支持多少个网络连接？这个简单的问题里其实埋了坑，导致无数的英雄好汉被困惑不解。就和树上九只鸟打死一只还剩几只的问题一样，没有和你说清楚树上是真鸟，还是假鸟。也没有说枪是有声还是无声的。通过今天的分析，相信你终于可以扬眉吐气把这个问题踩在脚下摩擦了。</p>
<p>TCP连接的客户端机：每一个ip可建立的TCP连接理论受限于ip_local_port_range参数，也受限于65535（端口号）。但可以通过配置多ip的方式来加大自己的建立连接的能力（一个网卡可能多个ip）。<br>TCP连接的服务器机：每一个监听的端口虽然理论值很大，但这个数字没有实际意义。最大并发数取决你的内存大小，每一条静止状态的TCP连接大约需要吃3 .3K的内存（与内存有关）。<br>————————————————<br>版权声明：本文为CSDN博主「zhangyanfei01」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/zhangyanfei01/article/details/110622360">https://blog.csdn.net/zhangyanfei01/article/details/110622360</a></p>

    </div>
    <p class="post-meta">
        <span class="post-cat">分类：
            <a class="cat-link" href="/categories/UPMP/">UPMP</a>
        </span>
        <span class="post-tags">
            标签：
            
        </span>
    </p>
</article>
<!-- 分享按钮 -->

  <div class="article-share clearfix text-center">
    <div class="share-area">
      <span class="share-txt">分享到：</span>
      <a href="javascript: window.open('http://service.weibo.com/share/share.php?url=' + encodeURIComponent(location.href) + '&title=' + document.title + '&language=zh_cn');" class="share-icon weibo"></a>
      <a href="javascript: alert('请复制链接到微信并发送');" class="share-icon wechat"></a>
      <a href="javascript: window.open('http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=' + encodeURIComponent(location.href) + '&title=' + document.title);" class="share-icon qqzone"></a>
      <a href="javascript: window.open('http://connect.qq.com/widget/shareqq/index.html?url=' + encodeURIComponent(location.href) + '&desc=Jelon个人博客&title=' + document.title + '&callback=' + encodeURIComponent(location.href));" class="share-icon qq"></a>
      <a href="javascript: window.open('http://shuo.douban.com/!service/share?href=' + encodeURIComponent(location.href) + '&name=' + document.title + '&text=' + document.title);" class="share-icon douban"></a>
    </div>
  </div>


<!-- 上一篇/下一篇 -->

<div class="article-nav clearfix">
    
    <span class="prev fl">
        上一篇<br >
        <a href="/2023/10/07/UPMP/%E9%80%9A%E7%94%A8%E4%B8%8B%E5%8D%95%E6%95%B4%E7%90%86/">
            
                无标题
            
        </a>
    </span>
    

    
    <span class="next fr">
        下一篇<br >
        <a href="/2023/10/07/UPMP/%E8%BF%90%E7%BB%B4%E5%B7%A5%E5%85%B7/">
            
                无标题
            
        </a>
    </span>
    
</div>

<!-- 文章评论 -->

  
<script src="/js/comment.js"></script>

  <div id="comments" class="comment">
    <!--
    <div class="sign-bar">
      GitHub 已登录!
      <span class="sign-link">登出</span>
    </div>
    <section class="box">
      <div class="com-avatar"><img src="/img/jelon.jpg" alt="avatar"></div>
      <div class="com-text">
        <div class="main">
          <textarea class="text-area-edited show" placeholder="欢迎评论！"></textarea>
          <div class="text-area-preview"></div>
        </div>
        <div class="switch">
          <div class="switch-item on">编辑</div>
          <div class="switch-item">预览</div>
        </div>
        <div class="button">提交</div>
      </div>
    </section>
    <section class="tips">注：评论支持 markdown 语法！</section>
    <section class="list-wrap">
      <ul class="list">
        <li>
          <div class="user-avatar">
            <a href="/">
              <img src="/img/jelon.jpg" alt="user-avatar">
            </a>
          </div>
          <div class="user-comment">
            <div class="user-comment-header">
              <span class="post-name">张德龙</span>
              <span class="post-time">2017年12月12日</span>
              <span class="like liked">已赞</span>
              <span class="like-num">2</span>
            </div>
            <div class="user-comment-body">333333</div>
          </div>
        </li>
        <li>
          <div class="user-avatar">
            <a href="/">
              <img src="/img/jelon.jpg" alt="user-avatar">
            </a>
          </div>
          <div class="user-comment">
            <div class="user-comment-header">
              <span class="post-name">刘德华</span>
              <span class="post-time">2017年12月12日</span>
              <span class="like">点赞</span>
              <span class="like-num">2</span>
            </div>
            <div class="user-comment-body">vvvvv</div>
          </div>
        </li>
      </ul>
      <div class="page-nav">
        <a href="javascript: void(0);" class="item">1</a>
        <a href="javascript: void(0);" class="item">2</a>
        <a href="javascript: void(0);" class="item current">3</a>
      </div>
    </section>
    -->
  </div>
  <script>
  JELON.Comment({
    container: 'comments',
    label: 'UPMP/运营看板优化2.0' || '2023/10/07/UPMP/运营看板优化2.0/',
    owner: 'ly1246621281',
    repo: 'blog_comments',
    clientId: 'b08ed25e52c57993e69c',
    clientSecret: '1cb9545488f0380904b87350e7c5a270ae03bab7'
  });
  </script>


            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    
    <section class="widget">
        <h3 class="widget-hd"><strong>文章搜索</strong></h3>
        <div class="search-form">
  <form
    id="searchForm"
    method="GET"
    action="https://www.baidu.com/s"
    ectype="application/x-www-form-urlencoded"
    target="_blank"
    autocomplete="false"
    onsubmit="javascript: return false;">
    <input
      id="searchKeyword"
      type="text"
      class="form-control"
      placeholder="输入关键字搜索"
      autocomplete="false"
    />
    <input id="searchKeywordHidden" type="hidden" name="wd" />
    <input id="searchButton" class="btn" type="submit" value="搜索" />
  </form>
</div>
    </section>
    

    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="/categories/Others/">Others</a>
        <span class="badge">(2)</span>
    </li>
    
    <li>
        <a href="/categories/Mysql/">Mysql</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/UPMP/">UPMP</a>
        <span class="badge">(27)</span>
    </li>
    
    <li>
        <a href="/categories/%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93/">个人总结</a>
        <span class="badge">(3)</span>
    </li>
    
    <li>
        <a href="/categories/JAVA%E6%80%BB%E7%BB%93/">JAVA总结</a>
        <span class="badge">(32)</span>
    </li>
    
    <li>
        <a href="/categories/JAVA%E6%80%BB%E7%BB%93/JAVA%EF%BC%882020-2023%EF%BC%89/">JAVA（2020--2023）</a>
        <span class="badge">(29)</span>
    </li>
    
    <li>
        <a href="/categories/JAVA%E6%80%BB%E7%BB%93/JAVA-2020/">JAVA (--2020)</a>
        <span class="badge">(3)</span>
    </li>
    
    <li>
        <a href="/categories/UPMP/%E8%BF%90%E8%90%A5%E7%9C%8B%E6%9D%BF/">运营看板</a>
        <span class="badge">(2)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="/tags/titleTag-tags2/" title="titleTag,tags2">titleTag,tags2 (1)</a>
  
    <a class="tag-item" href="/tags/hexo/" title="hexo">hexo (2)</a>
  
    <a class="tag-item" href="/tags/website/" title="website">website (2)</a>
  
    <a class="tag-item" href="/tags/%E5%89%8D%E7%AB%AF/" title="前端">前端 (2)</a>
  
    <a class="tag-item" href="/tags/%E8%AF%84%E5%AE%A1-%E4%B8%93%E4%BB%93/" title="评审,专仓">评审,专仓 (1)</a>
  
    <a class="tag-item" href="/tags/JAVA/" title="JAVA">JAVA (6)</a>
  
    <a class="tag-item" href="/tags/Mybatis/" title="Mybatis">Mybatis (1)</a>
  
    <a class="tag-item" href="/tags/Spring/" title="Spring">Spring (2)</a>
  
</div>
    </section>
    

    

    
    <!-- 友情链接 -->
    <section class="widget">
        <h3 class="widget-hd"><strong>友情链接</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
        <li>
            <a href="https://github.com/front-end-pigs/blog" target="_blank" title="Github博客">Github博客</a>
        </li>
    
</ul>
    </section>
    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    &copy;
    
        2016-2023
    

    <a href="/">Jelon Loves You</a>
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>

    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->

<script src="/js/main.js?v=1696677917841.js"></script>

</body>
</html>